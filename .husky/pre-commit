#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Colores para mensajes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo "${BLUE}â•‘  ğŸš€ Ejecutando verificaciones pre-commit...   â•‘${NC}"
echo "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo ""

# 1. Formateo de cÃ³digo con Prettier
echo "${YELLOW}ğŸ’… Formateando cÃ³digo con Prettier...${NC}"
if ! bun run format:check; then
  echo ""
  echo "${YELLOW}âš ï¸  CÃ³digo no estÃ¡ formateado correctamente${NC}"
  echo "${YELLOW}   Aplicando formato automÃ¡ticamente...${NC}"
  bun run format

  # Agregar archivos formateados al staging area
  git add -u

  echo "${GREEN}âœ… CÃ³digo formateado y agregado al commit${NC}"
else
  echo "${GREEN}âœ… CÃ³digo ya estÃ¡ correctamente formateado${NC}"
fi
echo ""

# 2. VerificaciÃ³n de tipos con TypeScript
echo "${YELLOW}ğŸ“ Verificando tipos con TypeScript...${NC}"
if ! bun run tsc --noEmit; then
  echo ""
  echo "${RED}âŒ Error: FallÃ³ la verificaciÃ³n de tipos TypeScript${NC}"
  echo "${RED}   Por favor, corrige los errores de tipos antes de hacer commit.${NC}"
  echo ""
  exit 1
fi
echo "${GREEN}âœ… VerificaciÃ³n de tipos completada exitosamente${NC}"
echo ""

# 3. Linting con ESLint
echo "${YELLOW}ğŸ” Ejecutando linter (ESLint)...${NC}"
if ! bun run lint; then
  echo ""
  echo "${RED}âŒ Error: FallÃ³ el linting${NC}"
  echo "${RED}   Por favor, corrige los errores de ESLint antes de hacer commit.${NC}"
  echo ""
  exit 1
fi
echo "${GREEN}âœ… Linting completado exitosamente${NC}"
echo ""

# 4. Verificar que no se estÃ©n agregando archivos sensibles
echo "${YELLOW}ğŸ”’ Verificando archivos sensibles...${NC}"
SENSITIVE_FILES=".env.local .env.production.local credentials.json"
for file in $SENSITIVE_FILES; do
  if git diff --cached --name-only | grep -q "^$file$"; then
    echo ""
    echo "${RED}âŒ Error: Intentando hacer commit de archivo sensible: $file${NC}"
    echo "${RED}   Este archivo contiene informaciÃ³n confidencial y no debe ser commiteado.${NC}"
    echo ""
    exit 1
  fi
done
echo "${GREEN}âœ… No se detectaron archivos sensibles${NC}"
echo ""

echo "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo "${GREEN}â•‘  âœ¨ Todas las verificaciones pasaron!         â•‘${NC}"
echo "${GREEN}â•‘  Procediendo con el commit...                  â•‘${NC}"
echo "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo ""
